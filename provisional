import numpy as np
import serial
import time

# === CONFIGURACIÓN ===
FILE_NAME = "SampleEDA.txt"   # cambia el nombre si hace falta
SERIAL_PORT = "/dev/ttyACM0"
BAUDRATE = 115200
SLEEP_SECONDS = 120           # cada cuánto se envía (2 min)

VCC = 3.3
N_BITS = 10                   # 0–1023

# === LEER EDA DESDE TXT ===
data = np.loadtxt(FILE_NAME, comments="#")

# Si es una sola columna -> 1D; si tiene más columnas -> última columna
if data.ndim == 1:
    eda_raw = data
else:
    eda_raw = data[:, -1]

# Convertir a voltios
eda_v = eda_raw / (2**N_BITS) * VCC
eda_mean = np.mean(eda_v)

print("EDA media (V):", eda_mean)

# === ENVIAR POR SERIAL EN BUCLE ===
ser = serial.Serial(SERIAL_PORT, BAUDRATE, timeout=1)
time.sleep(2)

try:
    while True:
        mensaje = f"{eda_mean:.4f}\n"
        ser.write(mensaje.encode("utf-8"))
        print("Enviado:", mensaje.strip())
        time.sleep(SLEEP_SECONDS)
except KeyboardInterrupt:
    print("Detenido por teclado.")
finally:
    ser.close()
